---
title: "timeSeries_Demo"

date: "2024-03-10"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```



# Assignment 3-1 (12.5% of Assignment 3)
First, load library and data 
Data are from Mortality, air pollution, and weather data for Baltimore City, Maryland, USA, 1987â€“2000.

Samet, Jonathan M., Scott L. Zeger, Francesca Dominici, Frank Curriero, Ivan Coursac, Douglas W. Dockery, Joel Schwartz, and Antonella Zanobetti. "The National Morbidity, Mortality, and Air Pollution Study." (2000).

Some pre-processing has been done by Tobias et al: 
https://github.com/aureliotobias/tsdatasets 
https://doi.org/10.1016/j.dib.2024.110694


# Instructions:    
 You need to show all the codes.    
 When asked to provide the results, you need to extract only the relevant part of R outputs. Cluttering the output will lead to inconsistent marking and delayed grading. **5%/25% of the grade is for the clarity of formatting**.    
 Please submit in PDF format to maintain the consistency of format and thus grading across all students. If you submit in any other format, we will not gurantee for fair evaluation on your work, and you are not able to negotiate any marks. You can generate an Rmarkdown file in HTML and then convert into the pdf format.    
 
 We might release the grade for the time-series part of the assignment, as the spatial one is more complex in terms  of the output and thus takes longer to grade. 
 
 
 
 
 
 
  
 
 


```{r pressure, message=FALSE, warning=FALSE}
# remove all variables to clean the environment 
rm(list = ls())

library(foreign) 
library(tidyverse)
library(dlnm)
library(Epi)
library(tsModel)
library(haven)
library(imputeTS)

bal <- readRDS("bal.rds")

```

# Log-transform the outcome (all death)
```{r}

# Log transform the outcome
bal$all <- log(bal$all)
```


### Imputation of the PM10 variable 
```{r} 
bal$pm10_original <- bal$pm10

# The original data has some missingness - impute them. 
bal$pm10 <- imputeTS::na_interpolation(bal$pm10, option = "spline")
sum(is.na(bal$pm10))
```



```{r}
# SET THE DEFAULT ACTION FOR MISSING DATA TO na.exclude
# (MISSING EXCLUDED IN ESTIMATION BUT RE-INSERTED IN PREDICTION/RESIDUALS)
options(na.action="na.exclude")

# check missing data 
lapply(bal, function(x) sum(is.na(x)))

# Display data, only first 5 lines  
head(bal, 5)

# Data structure
str(bal)

# SUMMARY
summary(bal)
```


# Q1 Perform the descriptive analysis     
  - Outcome is "all" cause mortality  
  - Exposure is PM10 (differentiated, so it has negative values)    
  -  Confounder is temperature  

Q1 - 1. What patterns are present in the outcome time-series?  
Q1 - 2. Is the outcome autocorrelated? If so, why? 
Q1 - 3. What types of adjustment would be needed for the etiologic analysis between all-cause mortality and PM 10?
Q1 - 4. Do you think that autocorrelation will disappear after controlling for the patterns you mentioned above?


```{r}
# Remove a few missing oiutcomes , less than 1%
#bal$pm10 <- NULL
#bal <- bal[complete.cases(bal), ]

# CORRELATIONS across each variables 
cor(bal[,2:7], use = "complete.obs")

# plot correlation - takes bit of time of see this plot 
pairs(bal[,2:7], main = "Pairwise correlation of varaibles")

```




### Make plots for the several time-series in the dataset
```{r}
# SET THE PLOTTING PARAMETERS FOR THE PLOT (SEE ?par)
# this allow making two pltos in one window
par(mar=c(2, 2, 2, 2), mex=0.8, mfrow=c(5,1))  # Sets smaller margins
oldpar <- par(no.readonly=TRUE)

# SUB-PLOT FOR DAILY DEATHS, WITH VERTICAL LINES DEFINING YEARS
plot(bal$date,bal$all,main="Daily deaths over time, natural log transformed ",
     ylab="Daily number of deaths", xlab = "week", type = "l")


plot(bal$date,bal$cvd,main="Daily CVD over time ",
     ylab="Daily number of deaths", xlab = "week", type = "l")


# Temperature 
plot(bal$date,bal$temp,main="Temperature",
     ylab="Daily temp",xlab="Date")

plot(bal$date,bal$dewp,main="Dewpoint",
     ylab="Dew",xlab="Date")

plot(bal$date,bal$pm10,main="PM",
     ylab="PM10",xlab="Date")


```

# Demonstration of time-series decomposition

```{r}
### Plot to decompose time-series - need to conver to a data structure called "ts"
tsData <- ts(bal$all[complete.cases(bal$all)], frequency = 365)
tsDataDecomposed <- decompose(tsData)
plot(tsDataDecomposed)
```


## How much autocorrelation in our outcome??, check with ACF 
Extremely strong temporal correlation in the count of death, meaning that count in one day is very similar to the counts in nearby days. ACF stands for autocorrealtion function     
```{r}
acf(bal$all[complete.cases(bal$all)], main = "Autocorrelation function (ACF) of the outcome")
```


## How much autocorrelation in the random componetn after de-trending?, check with ACF 
Much better, but still a lot of correlation - we will try to replicate this decomposition using regression in the demo below. 
```{r}
acf(tsDataDecomposed$random, na.action = na.pass, main = "ACF of the random compoenent after decomposition")
```








# Q2 Model the log(count) of all-bause mortality on the time-series of pm10.    
 - 2-1: Show the resulting association between the exposure and the outcome (do not just copy/paste lengthy R output). Show only the relevant section.   
 - 2-2: Interpret the results in terms of statistical conclusiveness and the magnnitude of the association   
 - 2-3: Show the ACF of the residuals and interpret in terms of the validity of the model. 
 - 2-4: show the standard assumptions of linear regressions, and interpret in terms of the validity.   
 



##Standard GLM-based Analysis (not really appropriate, but common in epidemology)

## Model 1 - unadjusted

### Impact of ozone exposure on the outcome 
```{r}
model1 <- lm(all ~ pm10, bal)  
ci.lin(model1,subset="pm10") %>%  round(digit = 4)
```
### ACF 
Residual shows strong autocorrelation. **The model is not valid.** 
```{r}
acf(residuals(model1, type = "response"), main = "ACF of Model 1, no adjustment", na.action = na.pass)
```


# Q3. Adjust for both cyclic patterns (use sine and consine functions) and trend. 
  - 3-1: Show the resulting association between the exposure and the outcome (do not just copy/paste lengthy R output) after adjustment for the cyclic patterns. Do you see any changes, in terms of the width of 95% CI and the point estimate form Model 1 above?    
  - 3-2: Show and interpret ACF of the residual. Interpret the change(s) in autocorrelation.   
  - Bonus question: use spline to model the trend and cyclic patterns, and show the resulting ACF. Interpret the findings. 
  
  
## Model 2 - season 

```{r}
#####################################
# OPTION 2: PERIODIC FUNCTIONS MODEL
# (FOURIER TERMS)
#####################################
# GENERATE FOURIER TERMS
# (USE FUNCTION harmonic, IN PACKAGE tsModel TO BE INSTALLED AND THEN LOADED)
# 4 SINE-COSINE PAIRS REPRESENTING DIFFERENT HARMONICS WITH PERIOD 1 YEAR

bal$time <- seq(nrow(bal))
fourier <- harmonic(bal$time,nfreq=4,period=365.25)

# FIT A POISSON MODEL FOURIER TERMS + LINEAR TERM FOR TREND
# (USE OF quasipoisson FAMILY FOR SCALING THE STANDARD ERRORS)
model2 <- lm(all ~ pm10 + fourier + time,bal)

# COMPUTE FITTED NUMBER OF DEATHS FROM THIS MODEL
pred2 <- predict(model2)

```

```{r}
#############
# FIGURE 2B in the manuscript
#############
par(mar=c(2, 2, 2, 2), mex=0.8, mfrow=c(2,1))
plot(x=bal$time, y= bal$all,lty = 1, 
     main="Diagnosis: Fitted sine-cosine functions (line) plus downward trend",ylab="Daily number of deaths",
     xlab="Date")
plot(x=bal$time, y=pred2, col = "red",lwd = 2, lty = 1)



```



### Autocorrelation: Lets diagnose the model that controlled for seasonality and trend. 
Compare the strength of autocorrelation (undesirable feature to be removed) between this plot and the plot without seasonality correction above. It is not great, but much better than the results from step 1 above (no control for seasonality) 

```{r}
#############
# Diagnosis of Model 2
#############
acf(residuals(model2), main = "ACF of the model that controlled for seasonality and trend", na.action = na.pass)
```



Rate Ratio, rate of death (# number of person-time) in response to one unit increase of ozone 
Now, the RR of ozone is positive, (or greater than 1.0 when exponentiated), meaning that ozone is associated with death after controlling for period effects 

```{r}
# Formatted table, only visible in HTML output 
ci.lin(model2,subset="pm10") %>%  round(digit = 3)
```




# Q4. Adjust for temperature, in addition to the cyclic patterns and trend above. 
  - 4-1: Show the resulting association between the exposure and the outcome after adjustment for temperature. Do you see any changes, in terms of the width of 95% CI and the point estimate form Model 1 above?    
  - 4-2: Show and interpret ACF of the residual. Interpret the change(s) in autocorrelation.   
  - Bonus question: use distributed lad model to adjust for temperature. 


# Q5. Adjust for dewpoints as well. 
  - 4-1: Show the resulting association between the exposure and the outcome after adjustment for temperature. Do you see any changes, in terms of the width of 95% CI and the point estimate form Model 1 above? Also, do you see any chagnes in ACF of the residuals, and why or why not?  
  



# Q6. Use distributed lag function (cross-basis function with linear dose-response association, as in the case of O3 in demo) to capture the lagged effect of PM10. 
  - 6-1: Show the resulting association between the exposure.   
  - 6-2: Interpret the finding, in terms of the statistical conclusiveness based on 95% CI, and the shape of the estimated lag function.   
  - 6-3: Show and interpret ACF of the residual. Interpret the change(s) in autocorrelation.   
  
  





## Model 3, 
Now control for temperature as well. For simplicity, temperature will be added as a categories variable, but spline is probably a better approach (not taught in this course) 

```{r}
# (TEMPERATURE MODELLED WITH CATEGORICAL VARIABLES FOR DECILES)
# (MORE SOPHISTICATED APPROACHES ARE AVAILABLE - SEE ARMSTRONG EPIDEMIOLOGY 2006)

cutoffs <- quantile(bal$temp,probs=0:10/10)
bal$tempdecile <- cut(bal$temp,breaks=cutoffs,include.lowest=TRUE)

plot(y=bal$tempdecile, x = bal$date, type = "l", main = "Plot of temperature level (cateogry) over time")

# CONTROLLING FOR TEMPERATURE, plus ozone and seasonality 
model3 <- lm(all ~ pm10 + fourier + time + tempdecile, bal)

```
Lets check RR 
```{r}
ci.lin(model3,subset="pm10") %>%  round(digit = 3)
```

Does not look too much better than step 2, controlling for season only 
...And ACF (autocorrelation) after accounting for temperature
```{r}
acf(residuals(model3), main = "ACF of residual, after controlling for temperature", na.action = na.pass)
```

### Additional info, coefficients of temperature (not so imporant imapct on death, likely because already adjusted by seasonality )
```{r}
summary(model3)
```






## Model 4.   Constrained distributed lag model 

### Settings for the exposure lag effect
```{r}
cbtempunc <- crossbasis(bal$temp,lag=5,
               argvar=list(df=5),
               #argvar=list(fun="strata", breaks=cutoffs[2:10]),
               #arglag=list(fun="integer"))
               arglag=list(fun="strata",breaks=1))

cbpmconstr <- crossbasis(bal$pm10,
              lag=15,
              argvar=list(fun="lin"),
arglag=list(fun="poly",degree=4))



model4 <- lm(all ~ cbpmconstr + cbtempunc + fourier + date, bal)

```


### Plot DLNM 

```{r}
pred4_pm <- crosspred(cbpmconstr,model4,at=15, cumul = TRUE, bylag = 0.2)
pred4_temp <- crosspred(cbtempunc,model4,at=5, bylag = 0.2)

plot(pred4_pm,var=15,type="p",ci="bars",col=1,pch=19, "slices",
     main="All lag terms modelled together (with costraints)",xlab="Lag (days)",
     ylab="RR and 95%CI per 10ug/m3 PM2 increase")

plot(pred4_pm, "slices", var=15, col=2, cumul=TRUE, ylab="Cumulative RR",
main="Cumulative association with a 10-unit increase in PM10")


```



### Impact of temperature - Compare the scale in the y-axis. 
The reduced RR 
```{r}
#############
# FIGURE 4C
#############

plot(pred4_temp,var=5, type="p",ci="bars",col=1,pch=19, 
     main="All lag terms modelled together (with costraints)",xlab="Lag (days)",
     ylab="RR and 95%CI per 10ug/m3 ozone increase")

```




## Autocurrelation for Model 4 
There is still residual correlation after accounting for all the factors like temperature, humidity, lag      
It still does not look perfect.....some varibale maybe missing        
```{r}
acf(residuals(model4), na.action = na.pass)
```


## Model 5 - AR(1) model 
### Finally, lets assume that death count in previous day is confoudning the count of death today i.e., associated with the exposure ie.g., O3, and death count in next day. In other words, we will control for the lagged outcome of 1 day (previous day) as a confounder. 
```{r}
# RUN THE MODEL AND OBTAIN PREDICTIONS FOR OZONE LEVEL 10ug/m3
bal$y_lag <- NA
bal$y_lag  <-  lag(bal$all)


model5 <- lm(all ~ cbpmconstr + cbtempunc + fourier + date + y_lag ,bal)
pred5 <- crosspred(cbpmconstr,model5,at=10)
```



## ACF of AR(1) model  
Now check ACF after controlling for the count of death from previous day   
IT still has issue in autcorrelation. 
```{r}
acf(residuals(model5), na.action = na.pass)
```



# Differenciation of Y variable makes 

```{r}

cbtempunc <- crossbasis(bal$temp,lag=c(0,10),
                        argvar=list(fun="strata",
                                    breaks=cutoffs[2:10]),
                        arglag=list(fun="integer"))

cbpmconstr <- crossbasis(bal$pm10,lag=c(0,10),
                         argvar=list(fun="lin"),
                         arglag=list(fun="strata",breaks=c(1,3)))


bal <- bal  %>% mutate(diff_y = all - lag(all))



model6<- lm(diff_y ~ cbpmconstr + cbtempunc, bal)
acf(residuals(model6), na.action = na.pass)

pred4_pm10 <- crosspred(cbpmconstr,model6,at=10)
pred4_Temp <- crosspred(cbtempunc,model6,at=10)


plot(pred4_Temp,var=10,type="p",ci="bars",col=1,pch=19,
     main="All lag terms modelled together (with costraints)",xlab="Lag (days)",
     ylab="RR and 95%CI per 10ug/m3 ozone increase")


plot(pred4_pm10,var=10,type="p",ci="bars",col=1,pch=19,
     main="All lag terms modelled together (with costraints)",xlab="Lag (days)",
     ylab="RR and 95%CI per 10ug/m3 ozone increase")

```

